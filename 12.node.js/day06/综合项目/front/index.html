<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>è‹±é›„ç®¡ç†ä¸»é¡µ</title>
	<link rel="stylesheet" href="./lib/bootstrap/css/bootstrap.min.css" />
	<style>
		.panel {
			width: 900px;
			margin: 10px auto;
		}

		.table img {
			width: 40px;
			height: 40px;
		}
	</style>
</head>

<body>
	<div class="container">
		<div class="panel panel-primary">
			<!-- Default panel contents -->
			<div class="panel-heading">è‹±é›„åˆ—è¡¨ç®¡ç†</div>
			<div class="panel-body">
				<!-- å­˜æ”¾çš„æœç´¢åŒºåŸŸ -->
				<div class="row">
					<div class="col-lg-6">
						<div class="input-group">
							<input type="text" id="hname" class="form-control" placeholder="è¾“å…¥è‹±é›„ä¿¡æ¯..." />
							<span class="input-group-btn">
								<button class="btn btn-default" id="btn_search" type="button">æœç´¢</button>
							</span>
						</div>
						<!-- /input-group -->
					</div>
					<!-- /.col-lg-6 -->
					<div class="col-lg-3 col-lg-offset-3">
						<!-- æ·»åŠ è‹±é›„çš„æŒ‰é’® -->
						<!-- 
              ğŸ§¨è°ƒç”¨æ¨¡æ€æ¡†çš„ä¸¤ä¸ªå±æ€§ï¼š
                  data-toggle="modal"                 ğŸ§¨ è°ƒç”¨åˆ‡æ¢æ¨¡æ€æ¡†åŠŸèƒ½
                  data-target="#exampleModal"         ğŸ§¨ è¦è°ƒç”¨å“ªä¸ªæ¨¡æ€æ¡†
            -->
						<button data-toggle="modal" data-target="#exampleModal" type="button" class="btn btn-success">
							æ·»åŠ è‹±é›„
						</button>
					</div>
				</div>
			</div>

			<!-- Table -->
			<table class="table">
				<thead>
					<tr>
						<th>ç¼–å·</th>
						<th>è‹±é›„åç§°</th>
						<th>è‹±é›„æ€§åˆ«</th>
						<th>å¤´åƒ</th>
						<th>æ“ä½œåŒº</th>
					</tr>
				</thead>
				<!-- è¡¨æ ¼ä¸»ä½“ -->
				<tbody id="tbody">
					<!-- tr æ˜¯ä¸€è¡Œå†…å®¹ -->
					<!-- <tr>
						<td>1</td>
						<td>å¤§ä¹”</td>
						<td>å¥³</td>
						<td><img src="" /></td>
						<td>
							<button type="button" class="btn btn-warning">ä¸Šä¼ å¤´åƒ</button>
							<button type="button" class="btn btn-danger">åˆ é™¤</button>
						</td>
					</tr> -->
				</tbody>
			</table>
		</div>
		<!-- ä¸Šä¼ æŒ‰é’®  display: none; æŠŠæŒ‰é’®éšè—èµ·æ¥ï¼Œä½†æ˜¯ç‚¹å‡»æŒ‰é’®è¿˜æ˜¯å¯ä»¥å®ç°ä¸Šä¼ çš„ -->
		<input type="file" id="uploadFile" style="display: none" />

		<!-- ğŸ§¨æ¨¡æ€æ¡†çš„ç»“æ„ - CVè¿‡æ¥çš„ -->
		<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
						<h4 class="modal-title" id="exampleModalLabel">æ·»åŠ è‹±é›„</h4>
					</div>
					<div class="modal-body">
						<form>
							<div class="form-group">
								<label for="recipient-name" class="control-label">è‹±é›„åç§°:</label>
								<input type="text" placeholder="è¯·è¾“å…¥è‹±é›„åç§°" class="form-control" id="heroName" />
							</div>
							<div class="form-group">
								<label for="message-text" class="control-label">è‹±é›„æ€§åˆ«:</label>
								<label><input type="radio" checked value="ç”·" name="gender" /> ğŸ‘¦ç”·ç”Ÿ</label>
								<label><input type="radio" value="å¥³" name="gender" /> ğŸ‘©â€ğŸ¦°å¥³ç”Ÿ</label>
							</div>
						</form>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">å…³é—­</button>
						<button id="addHeroBtn" type="button" class="btn btn-primary">æ·»åŠ </button>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- ğŸ§¨ å¿…é¡»å…ˆå¼•å…¥ jquery.js å†å¼•å…¥ bootstrap.js -->
	<script src="./lib/jquery/jquery.min.js"></script>
	<script src="./lib/bootstrap/js/bootstrap.js"></script>
	<script>
		// ä½ çš„ä»£ç 
		$(function () {
			// ajaxç»Ÿä¸€è¯·æ±‚å¤„ç†
			$.ajaxSetup({
				headers: {
					Authorization: localStorage.getItem('token'),
				}
			})
			//èº«ä»½è®¤è¯å¤±è´¥æ—¶ï¼Œå›åˆ°ç™»å½•é¡µé¢
			$(document).ajaxError(function (event, request, settings) {
				if (request.status === 401) {
					// alert(request.responseJSON.msg)
					return (location.href = './login.html')
				}
			})
			// è‹±é›„æ•°æ®æ›´æ–°
			getHeroList()
			function getHeroList() {
				const heroName = $('#hname').val().trim()

				$.ajax({
					type: 'get',
					url: 'http://127.168.0.1:3006/hero/getHeroList',
					data: { heroName: heroName },
					success: (res) => {
						// console.log(res);
						let htmlStr = '';
						$(res.data).each((index, item) => {
							htmlStr += `
							 <tr>
						<td>${item.id}</td>
						<td>${item.name}</td>
						<td>${item.gender}</td>
						<td><img src="${item.img}" /></td>
						<td>
							<button type="button" data-id="${item.id}" class="btn btn-warning">ä¸Šä¼ å¤´åƒ</button>
							<button type="button" data-id="${item.id}" class="btn btn-danger">åˆ é™¤</button>
						</td>
					</tr>
							`
						})
						$('#tbody').html(htmlStr)

					}
				})
			}
			// ç‚¹å‡»æœç´¢è‹±é›„
			$('#btn_search').click(function () {
				getHeroList()
			})

			// ç‚¹å‡»æ·»åŠ è‹±é›„
			$("#addHeroBtn").click(
				function () {
					const name = $('#heroName').val().trim();
					const gender = $("[name=gender]:checked").val().trim();
					$.ajax({
						type: 'post',
						url: 'http://127.168.0.1:3006/hero/addHero',
						data: { name, gender },
						success: (res) => {
							if (res.code = 200) {
								$('#exampleModal').modal('hide')
								getHeroList()
							}
						}
					})
				}
			)

			// ä¸Šä¼ å¤´åƒæŒ‰é’®ç‚¹å‡»
			$('#tbody').on('click', '.btn-warning', function () {
				// console.log('ä½ ç‚¹å‡»äº†ä¸Šä¼ å¤´åƒçš„æŒ‰é’®')
				// è°ƒç”¨çœŸæ­£çš„ä¸Šä¼ æ–‡ä»¶æŒ‰é’®
				$('#uploadFile').click()
				// è·å–åˆ—è¡¨æŒ‰é’®ä¸­çš„è‡ªå®šä¹‰ id å±æ€§
				const id = $(this).attr('data-id')
				// æŠŠè‡ªå®šä¹‰ id å±æ€§æ·»åŠ åˆ° çœŸæ­£çš„ä¸Šä¼ æŒ‰é’®ä¸­
				$('#uploadFile').attr('data-id', id)
			})

			// ğŸ˜¨ 5.2 çœŸæ­£çš„ä¸Šä¼ æŒ‰é’®
			$('#uploadFile').change(function () {
				// è·å–å…ƒç´ èº«ä¸Šçš„ id ï¼Œç”¨äºåæœŸæ›´æ–°å›¾ç‰‡çš„
				const id = $(this).attr('data-id')
				// console.log(id)
				// è·å–æ–‡ä»¶å¯¹è±¡
				const filesObj = $('#uploadFile').get(0).files[0]
				// console.log(filesObj);

				// å‡†å¤‡ FormData å¯¹è±¡ï¼Œä»¥åä½œä¸º ajax çš„è¯·æ±‚å‚æ•°
				const fd = new FormData()
				fd.append('file_data', filesObj)

				// Ajax è¯·æ±‚ï¼Œæ³¨æ„ FormData ä¸Šä¼ çš„æ—¶å€™æ³¨æ„çš„ 3 ä¸ªé—®é¢˜
				$.ajax({
					method: 'POST',
					url: 'http://127.0.0.1:3006/hero/uploadFile',
					data: fd, // FormData ç›´æ¥ä½œä¸ºå‚æ•°
					processData: false, // æ— éœ€ jq å¤„ç†æ•°æ®
					contentType: false, // æ— éœ€ jq å¤„ç†å†…å®¹ç±»å‹
					success: (res) => {
						// console.log(res, res.src)
						// æ›´æ–°å¤´åƒ
						$.ajax({
							method: 'POST',
							url: 'http://127.0.0.1:3006/hero/updateHero',
							data: {
								id: id,
								img: res.src,
							},
							success: (res) => {
								// å½“å›¾ç‰‡æ›´æ–°æˆåŠŸåï¼Œå†è·å–æœ€æ–°çš„åˆ—è¡¨æ•°æ®
								getHeroList()
							},
						})
					},
				})


			})

			//åˆ é™¤
			$('#tbody').on('click', '.btn-danger', function () {
				const id = $(this).attr('data-id');
				$.ajax({
					type: 'get',
					url: 'http://127.0.0.1:3006/hero/delHeroById',
					data: { id: id },
					success: (res) => {
						if (res.status === 500) alert('åˆ é™¤å¤±è´¥')
						if (res.code === 200) alert(`${res.msg}`)
						getHeroList()
					}
				})
			})

		})

	</script>
</body>

</html>